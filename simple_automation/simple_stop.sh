#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —É–ø—Ä–æ—â–µ–Ω–Ω–æ–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PID_FILE="$SCRIPT_DIR/simple_automation.pid"

echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —É–ø—Ä–æ—â–µ–Ω–Ω–æ–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏..."

if [ ! -f "$PID_FILE" ]; then
    echo "‚ö†Ô∏è  PID —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω. –ë–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω?"

    # –ü–æ–ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å –≤—Ä—É—á–Ω—É—é
    PIDS=$(pgrep -f "simple_button_automation.py")
    if [ -n "$PIDS" ]; then
        echo "üîç –ù–∞–π–¥–µ–Ω—ã –ø—Ä–æ—Ü–µ—Å—Å—ã: $PIDS"
        echo -n "–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏—Ö? (y/n): "
        read -r REPLY
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            kill $PIDS
            echo "‚úÖ –ü—Ä–æ—Ü–µ—Å—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
        fi
    else
        echo "‚ùå –ü—Ä–æ—Ü–µ—Å—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    fi
    exit 0
fi

PID=$(cat "$PID_FILE")

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ –ø—Ä–æ—Ü–µ—Å—Å
if ! ps -p "$PID" > /dev/null 2>&1; then
    echo "‚ö†Ô∏è  –ü—Ä–æ—Ü–µ—Å—Å —Å PID $PID –Ω–µ –Ω–∞–π–¥–µ–Ω (–≤–æ–∑–º–æ–∂–Ω–æ, —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)"
    rm -f "$PID_FILE"
    exit 0
fi

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å
echo "üî™ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–∏–≥–Ω–∞–ª–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å—É $PID..."
kill "$PID"

# –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (–º–∞–∫—Å–∏–º—É–º 5 —Å–µ–∫—É–Ω–¥)
for i in {1..5}; do
    if ! ps -p "$PID" > /dev/null 2>&1; then
        echo "‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        rm -f "$PID_FILE"
        exit 0
    fi
    sleep 1
done

# –ï—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –Ω–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º kill -9
echo "‚ö†Ô∏è  –ü—Ä–æ—Ü–µ—Å—Å –Ω–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞..."
kill -9 "$PID" 2>/dev/null
rm -f "$PID_FILE"
echo "‚úÖ –ë–æ—Ç –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
